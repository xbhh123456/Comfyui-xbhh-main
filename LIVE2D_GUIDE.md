# XBHH Live2D 使用与维护指南

本文档旨在指导如何为本扩展添加新模型、管理表情资源以及维护系统的稳定性。

---

## 1. 模型目录结构

模型存放于 `web/live2d/` 目录下，根据 SDK 版本分为两个子目录：

### SDK 2.0 模型 (V2)

- **存放路径**: `web/live2d/v2/[模型名称]/`
- **核心入口**: `model.json`
- **换装支持**: 系统会自动识别该目录下所有以 `model` 开头的 JSON 文件（如 `model.json`, `model1.json`, `model2.json`）。您可以点击 V2 侧边栏的“衣服”图标进行换装。

### SDK 4.0/5.0 模型 (V5)

- **存放路径**: `web/live2d/v4/` 或 `web/live2d/v5/`
- **核心入口**: `*.model3.json`
- **注意**: 文件夹名称应简洁，核心配置文件必须以 `.model3.json` 结尾。

---

## 2. 如何添加新模型

1. **准备模型文件**: 确保您拥有完整的 Live2D 模型导出文件夹。
2. **放置位置**:
   - 如果是旧版 V2 模型（文件后缀为 `.moc`），请放入 `web/live2d/v2/`。
   - 如果是新版 V5 模型（文件后缀为 `.moc3`），请放入 `web/live2d/v4/`。
3. **自动识别**:
   - 后端 API (`live2d_api.py`) 会在启动时自动扫描这些目录。
   - 您**不需要**手动修改 `waifu-tips.json` 里的路径，系统会自动动态生成配置。
4. **刷新界面**: 重启 ComfyUI 或刷新浏览器页面，在小人身上**点击右键**即可在模型切换菜单中看到新模型。

---

## 3. 表情与动作存储

### V2 模型

- **表情定义**: 通常直接写在 `model.json` 的 `expressions` 字段中。
- **存储路径**: 表情文件（`.json`）通常存放在模型文件夹下的 `expressions/` 或 `motions/` 子目录中。
- **调用方式**: 在前端右键菜单的“🎭 表情”子菜单中选择。

### V5 模型

- **配置文件**: 通过 `*.model3.json` 中的 `Expressions` 数组引用。
- **物理路径**: 对应的 `.exp3.json` 文件通常位于模型根目录下的 `expressions/` 文件夹。
- **注意**: V5 模型的表情名称通常由配置文件中的 `Name` 属性决定。

---

## 4. 关键注意事项 ⚠️

1.  **缓存冲突**:
    - 如果您修改了模型文件但前端没有变化，请尝试“清空浏览器本地存储”或点击菜单中的“退出”再重新打开。
    - 系统已内置重置逻辑，通常刷新页面即可解决 90% 的显示问题。
2.  **文件格式**:
    - 请确保 JSON 文件内部引用的路径是相对于该 JSON 文件的相对路径，不要包含绝对磁盘路径。
3.  **性能建议**:
    - 避免同时加载过多的 V5 模型（特别是高精度的模型），这可能会占用较多显存/内存。
4.  **ReferenceError 预防**:
    - 系统已实现驱动嗅探机制。如果模型加载过慢导致报 `AMotion is not defined` 等错误，系统会自动重试，通常无需干预。

---

## 5. 故障排除

- **小人不出现**: 检查 `localStorage` 是否被误设为隐藏，或后端服务是否正常运行。
- **无法切换换装**: 确保文件夹内存在 `model1.json` 等文件。
- **右键菜单不显示模型**: 检查 `pet/live2d_api.py` 是否正常加载，且模型文件夹中是否存在规范的入口文件。
